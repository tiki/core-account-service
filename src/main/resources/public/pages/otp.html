<!--
  ~ Copyright (c) TIKI Inc.
  ~ MIT license. See LICENSE file in root directory.
  -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="../assets/styles/main.css" rel="stylesheet" />
    <title>Login - OTP</title>
  </head>
  <body>
    <div class="flex h-screen w-screen">
      <div
        class="flex items-center justify-center w-screen sm:w-2/5 sm:bg-white bg-tiki-yellow-xxlight"
      >
        <div class="w-4/5 sm:w-4/5">
          <div>
            <img src="../assets/images/logo.svg" alt="Logo Tiki" class="w-24" />
            <h1 class="text-4xl text-tiki-dark-blue mt-5 font-bold">
              Enter Code
            </h1>
            <p class="mt-2 text-sm text-tiki-black-xlight">
              We have emailed you a one-time use code. Enter it below..
            </p>
          </div>
          <div class="mt-5">
            <form action="" id="tikiOtpForm">
              <label
                for="code"
                class="block text-tiki-black-xlight font-bold text-sm"
                >Code</label
              >
              <input
                type="text"
                name="code"
                id="code"
                class="w-full my-2 p-2 border-2 border-solid border-black rounded-md"
                placeholder="ABC123"
              />
              <div id="error" class="text-sm my-2 text-pink-dark hidden">
                That didn't work ðŸ«  â€” double check your email, or go back and
                request a new code.
              </div>
              <button
                type="submit"
                class="cursor-pointer p-4 border-none border rounded-md w-full bg-black text-yellow-dark mt-2 hover:"
              >
                Continue
              </button>
            </form>
          </div>
        </div>
      </div>
      <div
        class="hidden sm:w-3/5 bg-tiki-yellow-xxlight sm:flex items-center justify-center"
      >
        <div>
          <img
            src="../assets/images/pineapple-butt-w-200.png"
            alt="tiki pineapple"
          />
        </div>
      </div>
    </div>
    <script>
      document
        .getElementById("tikiOtpForm")
        .addEventListener("submit", (event) => {
          event.preventDefault();
          let decodedCookie = decodeURIComponent(document.cookie);
          let name = "TikiAccountOtpUser=";
          let username;
          let ca = decodedCookie.split(";");
          for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == " ") {
              c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
              username = c.substring(name.length, c.length);
            }
          }

          const data = new FormData(event.target);
          const dataObject = Object.fromEntries(data.entries());

          let headers = new Headers();
          headers.append("accept", "application/json");
          headers.append(
            "Content-Type",
            "application/x-www-form-urlencoded;charset=UTF-8"
          );

          const options = {
            method: "POST",
            headers: headers,
            body: new URLSearchParams({
              grant_type: "password",
              username: username,
              password: dataObject.code,
              scope: "account admin",
            }),
          };

          fetch(`https://account.mytiki.com/api/latest/auth/token`, options)
            .then(async (response) => {
              const data = await response.json();
              console.log(data);

              // Now I must use the JWT that comes from response to redirect to readme
            })
            .catch((error) => {
              console.log("error: ", error);
              let element = document.getElementById("error");
              element.classList.remove("hidden");
            });
        });
    </script>
  </body>
</html>
